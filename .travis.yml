language: node_js

# Use the latest stable version
node_js:
  - node
  
# Disable npm caching
cache:
  npm: false

# For testing environment
addons:
  chrome: stable

branches:
  only:
  - master
  - dev-1
  - e2e-tests # TODO: Delete after merge in dev-1
  
before_install:
- export TZ=Europe/Berlin

install:
  - npm install -g yuidocjs
  - npm install --no-package-lock

# Version Matrix
jobs:
  fast_finish: true
  include:
    - stage: Test (Ember release version)
      env:
        - EMBER_VERSION=release
    script: ember test

    - stage: Test (Ember beta version)
     allow_failure: true
     env:
       - EMBER_VERSION=beta
     script: ember test

    - stage: E2E Test (gauge + taiko)
      addons:
        apt:
          update: true
          sources:
              - sourceline: "deb https://dl.bintray.com/gauge/gauge-deb stable main"
                key_url: "http://ha.pool.sks-keyservers.net/pks/lookup?search=0x023EDB0B&op=get&options=mr"
          packages:
              - gauge
      
      script: 
        - docker-compose -f docker-compose-complete.yml up -d
        - cd E2E-tests
        - npm install
        - gauge install js
        - npm test # starts gauge and taiko test scenarios
    
      sudo: true

    - stage: deploy
      if: (type = push) AND (type != pull_request) AND ((branch = dev-1) OR (branch = master))
      skip_cleanup: false
      env:
        - EMBER_VERSION=release
      script: ember build --prod && chmod +x .travis/docker_push.sh && .travis/docker_push.sh

    - stage: documentation
      if: (type = push) AND (type != pull_request) AND (branch = master)
      skip_cleanup: false
      env:
        - EMBER_VERSION=release
      script: chmod +x .travis/yuidoc_push.sh && .travis/yuidoc_push.sh
